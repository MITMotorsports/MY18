name: MY18
archs:
  - avr
  - arm
boards:
  can_node:
    arch: arm
    publish:
      can0:
        - FrontCanNodeBrakeThrottle
        - FrontCanNodeWheelSpeed
    subscribe:
      can0:
        - RearCanNodeWheelSpeed
        - VcuToDash
  rear_can_node:
    arch: arm
    publish:
      can0:
        - RearCanNodeWheelSpeed
  vcu:
    arch: avr
    publish:
      can0:
        - VcuToDash
        - BMSRequest
        - MCCommand
    subscribe:
      can0:
        - FrontCanNodeBrakeThrottle
        - DashRequest
        - MCVoltage
  dash:
    arch: avr
    publish:
      can0:
        - DashRequest
    subscribe:
      can0:
        - VcuToDash
        - BMSHeartbeat
        - FrontCanNodeBrakeThrottle
        - RearCanNodeWheelSpeed
  bms:
    arch: arm
    publish:
      can0:
        - BMSHeartbeat
        - CellVoltages
        - CellTemperatures
  button_bank:
    arch: arm
    publish:
      can0:
        - ButtonRequest
  mc:
    subscribe:
      can0:
        - MCCommand
    publish:
      can0:
        - MCVoltage
  current_sensor:
    publish:
      can0:
        - CurrentSensor_Current
        - CurrentSensor_Voltage
        - CurrentSensor_Power
    subscribe:
      can0:
        - Current_Sensor_Config

buses:
  can0:
    baudrate: 500000
    is_extended: false
    messages:
      FrontCanNodeBrakeThrottle:
        can_id: 0x0D0
        period: 0.02s
        is_big_endian: true
        segments:
          accel_1:
            position: 0
            length: 16
            c_type: uint16_t
            signed: false
          accel_2:
            position: 16
            length: 16
            c_type: uint16_t
            signed: false
          brake_1:
            position: 32
            length: 16
            c_type: uint16_t
            signed: false
          brake_2:
            position: 48
            length: 16
            c_type: uint16_t
            signed: false
      FrontCanNodeWheelSpeed:
        can_id: 0x0F0
        is_big_endian: true
        period: 0.2s
        segments:
          front_right_wheel_speed:
            position: 0
            length: 32
            c_type: uint32_t
            signed: false
            unit: mRPM
          front_left_wheel_speed:
            position: 32
            length: 32
            c_type: uint32_t
            signed: false
            unit: mRPM
      CellTemperatures:
        can_id: 0x0F1
        period: 10s
        is_big_endian: true
        segments:
          min:
            position: 0
            length: 10
            c_type: int16_t
            signed: false
            unit: dC
          argmin:
            position: 10
            length: 9
            c_type: uint16_t
            signed: false
          max:
            position: 19
            length: 10
            c_type: int16_t
            signed: false
            unit: dC
          argmax:
            position: 29
            length: 9
            c_type: uint16_t
            signed: false
      CellVoltages:
        can_id: 0x0F2
        period: 0.3s
        is_big_endian: true
        segments:
          min:
            position: 0
            length: 32
            c_type: uint32_t
            signed: false
            unit: mV
          max:
            position: 32
            length: 32
            c_type: uint32_t
            signed: false
            unit: mV
      BMSHeartbeat:
        can_id: 0x0D9
        period: 0.02ms
        is_big_endian: true
        segments:
          # error_pec:
          #   position: 0
          #   length: 1
          #   c_type: bool
          # error_cvst:
          #   position: 1
          #   length: 1
          #   c_type: bool
          # error_owt:
          #   position: 2
          #   length: 1
          #   c_type: bool
          # error_eeprom:
          #   position: 3
          #   length: 1
          #   c_type: bool
          # error_cell_under_voltage:
          #   position: 4
          #   length: 1
          #   c_type: bool
          # error_cell_over_voltage:
          #   position: 5
          #   length: 1
          #   c_type: bool
          # error_cell_under_temp:
          #   position: 6
          #   length: 1
          #   c_type: bool
          # error_cell_over_temp:
          #   position: 7
          #   length: 1
          #   c_type: bool
          # error_over_current:
          #   position: 8
          #   length: 1
          #   c_type: bool
          # error_can:
          #   position: 9
          #   length: 1
          #   c_type: bool
          # error_conflicting_mode_requests:
          #   position: 10
          #   length: 1
          #   c_type: bool
          # error_vcu_dead:
          #   position: 11
          #   length: 1
          #   c_type: bool
          # error_control_flow:
          #   position: 12
          #   length: 1
          #   c_type: bool
          # error_blown_fuse:
          #   position: 13
          #   length: 1
          #   c_type: bool
          # error_L_contactor_welded:
          #   position: 14
          #   length: 1
          #   c_type: bool
          # error_H_contactor_welded:
          #   position: 15
          #   length: 1
          #   c_type: bool
          L_contactor_closed:
            position: 0
            length: 1
            c_type: bool
          H_contactor_closed:
            position: 4
            length: 1
            c_type: bool
          L_contactor_welded:
            position: 8
            length: 1
            c_type: bool
          H_contactor_welded:
            position: 16
            length: 1
            c_type: bool
          soc:
            position: 20
            length: 8
            c_type: uint8_t
      BMSRequest:
        can_id: 0x0D3
        period: 1s
        is_big_endian: true
        segments:
          state:
            position: 0
            length: 1
            c_type: enum
            enum:
              DISCHARGE_ENABLE: 0x0
              DISCHARGE_DISABLE: 0x1
              NO_REQUEST: 0x2
      VcuToDash:
        can_id: 0x0F3
        period: 0.1s
        is_big_endian: true
        segments:
          rtd_light_on:
            position: 0
            length: 1
            c_type: bool
          ams_light_on:
            position: 1
            length: 1
            c_type: bool
          imd_light_on:
            position: 2
            length: 1
            c_type: bool
          hv_light_on:
            position: 3
            length: 1
            c_type: bool
          traction_control:
            position: 4
            length: 1
            c_type: bool
          limp_mode_on:
            position: 5
            length: 1
            c_type: bool
          lv_warning_on:
            position: 6
            length: 1
            c_type: bool
          active_aero_on:
            position: 7
            length: 1
            c_type: bool
          regen_on:
            position: 8
            length: 1
            c_type: bool
          shutdown_esd_drain_open:
            position: 9
            length: 1
            c_type: bool
          shutdown_bms_open:
            position: 10
            length: 1
            c_type: bool
          shutdown_imd_open:
            position: 11
            length: 1
            c_type: bool
          shutdown_bspd_open:
            position: 12
            length: 1
            c_type: bool
          shutdown_vcu_open:
            position: 13
            length: 1
            c_type: bool
          shutdown_precharge_open:
            position: 14
            length: 1
            c_type: bool
          shutdown_master_reset_open:
            position: 15
            length: 1
            c_type: bool
          shutdown_driver_reset_open:
            position: 16
            length: 1
            c_type: bool
          heartbeat_front_can_node_dead:
            position: 25
            length: 1
            c_type: bool
          heartbeat_rear_can_node_dead:
            position: 26
            length: 1
            c_type: bool
          heartbeat_bms_dead:
            position: 27
            length: 1
            c_type: bool
          heartbeat_dash_dead:
            position: 28
            length: 1
            c_type: bool
          heartbeat_mc_dead:
            position: 29
            length: 1
            c_type: bool
          heartbeat_current_sensor_dead:
            position: 30
            length: 1
            c_type: bool
          tsms_off:
            position: 31
            length: 1
            c_type: bool
          reset_latch_open:
            position: 32
            length: 1
            c_type: bool
          precharge_running:
            position: 33
            length: 1
            c_type: bool
          master_reset_not_initialized:
            position: 34
            length: 1
            c_type: bool
          driver_reset_not_initialized:
            position: 35
            length: 1
            c_type: bool
          lv_battery_voltage:
            position: 40
            length: 10
            c_type: uint16_t
            signed: false
          limp_state:
            position: 50
            length: 3
            c_type: enum
            enum:
              LIMP_NORMAL: 0x0
              LIMP_50: 0x1
              LIMP_33: 0x2
              LIMP_25: 0x3
          vcu_car_state:
            position: 53
            length: 3
            c_type: enum
            enum:
              VCU_STATE_ROOT: 0x0
              VCU_STATE_LV: 0x1
              VCU_STATE_PRECHARGING: 0x2
              VCU_STATE_RTD: 0x3
              VCU_STATE_DRIVING: 0x4
          vcu_error_state:
            position: 56
            length: 3
            c_type: enum
            enum:
              NO_ERROR_STATE: 0x0
              RECOVERABLE_ERROR_STATE: 0x1
              FATAL_ERROR_STATE: 0x2

      RearCanNodeWheelSpeed:
        can_id: 0x0D1
        period: 0.02s
        is_big_endian: true
        segments:
          rear_right_wheel_speed:
            position: 0
            length: 32
            c_type: uint32_t
            signed: false
            unit: mRPM
          rear_left_wheel_speed:
            position: 32
            length: 32
            c_type: uint32_t
            signed: false
            unit: mRPM
      CurrentSensor_Current:
        can_id: 0x521
        period: 0.05s
        is_big_endian: true
        segments:
          pack_current:
            position: 16
            length: 32
            c_type: int32_t
            signed: true
            unit: mA
      CurrentSensor_Voltage:
        can_id: 0x522
        period: 0.05s
        is_big_endian: false
        segments:
          dc_bus_voltage:
            position: 16
            length: 32
            c_type: int32_t
            signed: true
            unit: mV
      CurrentSensor_Power:
        can_id: 0x526
        period: 0.05s
        is_big_endian: false
        segments:
          power:
            position: 16
            length: 32
            c_type: int32_t
            signed: false
            unit: W
      CurrentSensor_Energy:
        can_id: 0x528
        period: 0.05s
        is_big_endian: false
        segments:
          pack_energy:
            position: 16
            length: 32
            c_type: int32_t
            signed: false
            unit: Whrs
      DashRequest:
        can_id: 0x0D2
        is_big_endian: true
        segments:
          type:
            position: 0
            length: 3
            c_type: enum
            enum:
              NO_REQUEST: 0x0
              TRACTION_CONTROL_ENABLE: 0x5
              TRACTION_CONTROL_DISABLE: 0x6
              ACTIVE_AERO_ENABLE: 0x7
              ACTIVE_AERO_DISABLE: 0x8
              FAN_ENABLE: 0x9
              FAN_DISABLE: 0xA
      ButtonRequest:
        can_id: 0x0D8
        period: 0.05s
        is_big_endian: true
        segments:
          RTD:
            position: 0
            length: 1
            c_type: bool
            unit: pressed
          DriverReset:
            position: 1
            length: 1
            c_type: bool
            unit: pressed
          ScrollSelect:
            position: 2
            length: 1
            c_type: bool
            unit: pressed
      MCCommand:
        can_id: 0x0C0 # From manual
        period: 0.05s  # MC needs a message at 2 Hz or higher
        is_big_endian: false
        segments:
          torque:
            position: 0
            length: 16
            c_type: int16_t
            signed: true
            unit: dNm
          angular_vel:
            position: 16
            length: 16
            c_type: int16_t
            signed: signed
            unit: RPM
          direction_is_counterclockwise: # when viewed from shaft end of motor
            position: 39
            length: 1
            c_type: bool
          inverter_enabled:
            position: 47
            length: 1
            c_type: bool
          discharge_enabled:
            position: 46
            length: 1
            c_type: bool
          speed_mode:
            position: 45
            length: 1
            c_type: bool
          torque_limit:
            position: 48
            length: 16
            c_type: int16_t
            unit: dNm
      MCParameterRequest:
        can_id: 0x0C1
        is_big_endian: false
        segments:
          address:
            position: 0
            length: 16
            c_type: int16_t
            signed: true
            unit: dNm
          write:  # make an enum {read, write}
            position: 23
            length: 1
            c_type: bool
            signed: signed
            unit: RPM
          data:
            position: 32
            length: 16
            c_type: int16_t
      MCVoltage:
        can_id: 0x0A7
        period: 1cs
        is_big_endian: false
        segments:
          bus:
            position: 0
            length: 16
            unit: dV
            signed: true
            c_type: int16_t
          out:
            position: 16
            length: 16
            unit: dV
            signed: true
            c_type: int16_t
          VAB_Vd:
            position: 32
            length: 16
            unit: dV
            signed: true
            c_type: int16_t
          VBC_Vq:
            position: 48
            length: 16
            unit: dV
            signed: true
            c_type: int16_t
      Current_Sensor_Config:
        period: 1s # Fake, just there to make can lib not complain
        can_id: 0x411
        is_big_endian: true
        segments:
          muxbyte:
            position: 0
            length: 8
            signed: false
            c_type: uint8_t
          db1:
            position: 8
            length: 8
            signed: false
            c_type: uint8_t
          db2:
            position: 16
            length: 8
            signed: false
            c_type: uint8_t
          db3:
            position: 24
            length: 8
            signed: false
            c_type: uint8_t
          db4:
            position: 32
            length: 8
            signed: false
            c_type: uint8_t
          db5:
            position: 40
            length: 8
            signed: false
            c_type: uint8_t
          db6:
            position: 48
            length: 8
            signed: false
            c_type: uint8_t
          db7:
            position: 56
            length: 8
            signed: false
            c_type: uint8_t
